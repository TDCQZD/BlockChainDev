(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{1005:function(e,t,n){__NEXT_REGISTER_PAGE("/projects/detail",function(){return e.exports=n(1006),{page:e.exports.default}})},1006:function(e,t,n){"use strict";n.r(t);var r=n(23),a=n.n(r),o=n(0),i=n.n(o),s=n(2),c=n(49),l=n(14),u=n(50),p=(n(121),n(64)),m=n(65),f=n(39);function y(e){return(y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function h(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function d(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function v(e){return function(){var t=this,n=arguments;return new Promise(function(r,a){var o=e.apply(t,n);function i(e){d(o,r,a,i,s,"next",e)}function s(e){d(o,r,a,i,s,"throw",e)}i(void 0)})}}function b(e){return(b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function E(e,t,n){return t&&g(e.prototype,t),n&&g(e,n),e}function w(e,t){return(w=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function x(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var P=function(e){var t,n,r,o;function p(e){var t,n,r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,p),n=this,(t=!(r=b(p).call(this,e))||"object"!==y(r)&&"function"!=typeof r?x(n):r).state={amount:0,errmsg:"",loading:!1,isApproving:!1,isPaying:!1},t.onSubmit=t.contributeProject.bind(x(x(t))),t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&w(e,t)}(p,i.a.Component),E(p,null,[{key:"getInitialProps",value:(t=v(a.a.mark(function e(t){var n,r,o,i,s,c,l,p,m,f,y,d,v,b,g,E,w;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.query,r=Object(u.a)(n.address),e.next=4,r.methods.getSummary().call();case 4:for(o=e.sent,i=Object.values(o),s=h(i,8),c=s[0],l=s[1],p=s[2],m=s[3],f=s[4],y=s[5],d=s[6],v=s[7],b=[],g=0;g<d;g++)b.push(r.methods.payments(g).call());return e.next=10,Promise.all(b);case 10:return E=e.sent,w={address:n.address,description:c,minInvest:l,maxInvest:p,goal:m,balance:f,investorCount:y,paymentCount:d,owner:v,payments:E},e.abrupt("return",{project:w});case 13:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})}]),E(p,[{key:"doPayment",value:(o=v(a.a.mark(function e(t){var n,r,o;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.setState({isPaying:t}),e.next=4,l.a.eth.getAccounts();case 4:if(n=e.sent,(r=n[0])===this.props.project.owner){e.next=8;break}return e.abrupt("return",window.alert("只有管理员才能划转资金"));case 8:return o=Object(u.a)(this.props.project.address),e.next=11,o.methods.doPayment(t).send({from:r,gas:"5000000"});case 11:e.sent,window.alert("资金划转成功"),setTimeout(function(){location.reload()},1e3),e.next=20;break;case 16:e.prev=16,e.t0=e.catch(0),console.error(e.t0),window.alert(e.t0.message||e.t0.toString());case 20:return e.prev=20,this.setState({isPaying:!1}),e.finish(20);case 23:case"end":return e.stop()}},e,this,[[0,16,20,23]])})),function(e){return o.apply(this,arguments)})},{key:"approvePayment",value:(r=v(a.a.mark(function e(t){var n,r,o;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.setState({isApproving:t}),e.next=4,l.a.eth.getAccounts();case 4:return n=e.sent,r=n[0],o=Object(u.a)(this.props.project.address),e.next=9,o.methods.investors(r).call();case 9:if(e.sent){e.next=12;break}return e.abrupt("return",window.alert("只有投资人才有权投票"));case 12:return e.next=14,o.methods.approvePayment(t).send({from:r,gas:"5000000"});case 14:e.sent,window.alert("投票成功"),setTimeout(function(){location.reload()},1e3),e.next=23;break;case 19:e.prev=19,e.t0=e.catch(0),console.error(e.t0),window.alert(e.t0.message||e.t0.toString());case 23:return e.prev=23,this.setState({isApproving:!1}),e.finish(23);case 26:case"end":return e.stop()}},e,this,[[0,19,23,26]])})),function(e){return r.apply(this,arguments)})},{key:"getInputHandler",value:function(e){var t=this;return function(n){console.log(n.target.value),t.setState(function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}({},e,n.target.value))}}},{key:"contributeProject",value:(n=v(a.a.mark(function e(){var t,n,r,o,i,s,c,p,m,f;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.state.amount,n=this.props.project,r=n.minInvest,o=n.maxInvest,i=l.a.utils.fromWei(r,"ether"),s=l.a.utils.fromWei(o,"ether"),console.log({amount:t,minInvestInEther:i,maxInvestInEther:s}),!(t<=0)){e.next=7;break}return e.abrupt("return",this.setState({errmsg:"投资金额必须大于0"}));case 7:if(!(parseInt(t)<parseInt(i))){e.next=9;break}return e.abrupt("return",this.setState({errmsg:"投资金额必须大于最小投资金额"}));case 9:if(!(parseInt(t)>parseInt(s))){e.next=11;break}return e.abrupt("return",this.setState({errmsg:"投资金额必须小于最大投资金额"}));case 11:return e.prev=11,this.setState({loading:!0,errmsg:""}),e.next=15,l.a.eth.getAccounts();case 15:return c=e.sent,p=c[0],m=Object(u.a)(this.props.project.address),e.next=20,m.methods.contribute().send({from:p,value:l.a.utils.toWei(t,"ether"),gas:"5000000"});case 20:f=e.sent,this.setState({errmsg:"投资成功",amount:0}),console.log(f),setTimeout(function(){location.reload()},1e3),e.next=30;break;case 26:e.prev=26,e.t0=e.catch(11),console.error(e.t0),this.setState({errmsg:e.t0.message||e.t0.toString()});case 30:return e.prev=30,this.setState({loading:!1}),e.finish(30);case 33:case"end":return e.stop()}},e,this,[[11,26,30,33]])})),function(){return n.apply(this,arguments)})},{key:"render",value:function(){var e=this.props.project;return i.a.createElement(m.a,null,i.a.createElement(s.q,{variant:"title",color:"inherit",style:{margin:"15px 0"}},"项目详情"),this.renderBasicInfo(e),i.a.createElement(s.q,{variant:"title",color:"inherit",style:{margin:"30px 0 15px"}},"资金支出请求"),this.renderPayments(e))}},{key:"renderPayments",value:function(e){var t=this;return console.log(e),i.a.createElement(s.i,{style:{padding:"15px"}},i.a.createElement(s.j,{style:{marginBottom:"30px"}},i.a.createElement(s.m,null,i.a.createElement(s.n,null,i.a.createElement(s.l,null,"用途"),i.a.createElement(s.l,null,"金额"),i.a.createElement(s.l,null,"收款方"),i.a.createElement(s.l,null,"完成状态"),i.a.createElement(s.l,null,"投票状态"),i.a.createElement(s.l,null,"操作"))),i.a.createElement(s.k,null,e.payments.map(function(n,r){return t.renderPaymentRow(n,r,e)}))),i.a.createElement(c.Link,{route:"/projects/".concat(e.address,"/payments/create")},i.a.createElement(s.b,{variant:"raised",color:"primary"},"创建资金支出请求")))}},{key:"renderBasicInfo",value:function(e){var t=e.balance/e.goal*100;return i.a.createElement(s.i,{style:{padding:"15px"}},i.a.createElement(s.q,{gutterBottom:!0,variant:"headline",component:"h2"},e.description),i.a.createElement(s.h,{style:{margin:"10px 0"},color:"primary",variant:"determinate",value:t}),i.a.createElement(s.g,{container:!0,spacing:16},i.a.createElement(f.a,{title:"".concat(l.a.utils.fromWei(e.goal,"ether")," ETH"),description:"募资上限"}),i.a.createElement(f.a,{title:"".concat(l.a.utils.fromWei(e.minInvest,"ether")," ETH"),description:"最小投资金额"}),i.a.createElement(f.a,{title:"".concat(l.a.utils.fromWei(e.maxInvest,"ether")," ETH"),description:"最大投资金额"}),i.a.createElement(f.a,{title:"".concat(e.investorCount,"人"),description:"参投人数"}),i.a.createElement(f.a,{title:"".concat(l.a.utils.fromWei(e.balance,"ether")," ETH"),description:"已募资金额"})),i.a.createElement(s.g,{container:!0,spacing:16},i.a.createElement(s.g,{item:!0,md:12},i.a.createElement(s.o,{required:!0,id:"amount",label:"投资金额",style:{marginRight:"15px"},value:this.state.amount,onChange:this.getInputHandler("amount"),margin:"normal",InputProps:{endAdornment:"ETH"}}),i.a.createElement(s.b,{size:"small",variant:"raised",color:"primary",onClick:this.onSubmit},this.state.loading?i.a.createElement(s.f,{color:"secondary",size:24}):"立即投资"),!!this.state.errmsg&&i.a.createElement(s.q,{component:"p",style:{color:"red"}},this.state.errmsg))))}},{key:"renderPaymentRow",value:function(e,t,n){var r=this,a=!e.completed,o=!e.completed&&e.voterCount/n.investorCount>.5;return i.a.createElement(s.n,{key:e.id},i.a.createElement(s.l,null,e.description),i.a.createElement(s.l,null,l.a.utils.fromWei(e.amount,"ether")," ETH"),i.a.createElement(s.l,null,e.receiver),i.a.createElement(s.l,null,e.completed?"是":"否"),i.a.createElement(s.l,null,e.voterCount,"/",n.investorCount),i.a.createElement(s.l,null,a&&i.a.createElement(s.b,{size:"small",color:"primary",onClick:function(){return r.approvePayment(t)}},this.isApproving(t)?i.a.createElement(s.f,{color:"secondary",size:24}):"投赞成票"),o&&i.a.createElement(s.b,{size:"small",color:"primary",onClick:function(){return r.doPayment(t)}},this.isPaying(t)?i.a.createElement(s.f,{color:"secondary",size:24}):"资金划转")))}},{key:"isApproving",value:function(e){return"number"==typeof this.state.isApproving&&this.state.isApproving===e}},{key:"isPaying",value:function(e){return"number"==typeof this.state.isPaying&&this.state.isPaying===e}}]),p}();t.default=Object(p.a)(P)},39:function(e,t,n){"use strict";var r=n(0),a=n.n(r),o=n(2),i=n(22);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var m=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),l(this,u(t).apply(this,arguments))}var n,r,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(t,a.a.Component),n=t,(r=[{key:"render",value:function(){var e=this.props,t=e.classes,n=e.title,r=e.description;return a.a.createElement(o.g,{item:!0,md:4},a.a.createElement("div",{className:t.container},a.a.createElement(o.q,{variant:"title",color:"inherit",className:t.title},n),a.a.createElement(o.q,{variant:"paragraph",color:"inherit",className:t.description},r)))}}])&&c(n.prototype,r),i&&c(n,i),t}();t.a=Object(i.withStyles)({container:{padding:"0.5em 1em",border:"1px dotted #AAA"},title:{color:"#333",marginBottom:"10px",fontWeight:"bold"},description:{margin:0,color:"#666"}})(m)}},[[1005,1,0]]]);