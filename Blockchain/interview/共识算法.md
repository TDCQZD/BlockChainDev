# 共识算法
## 解决拜占庭问题的算法
### PoW - bitcoin

### PoS 
在PoW中，节点之间通过hash的计算力来竞赛以获取下一个区块的记账权，而在PoS中，块是已经铸造好的(这里没有“挖矿”的概念，所以我们不用这个词来证明股份)，铸造的过程是基于每个节点(Node)愿意作为抵押的令牌(Token)数量。

这些参与抵押的节点被称为验证者(Validator)，**验证者和节点的概念是等同的！**令牌的含义对于不同的区块链平台是不同的，例如，在以太坊中，每个验证者都将Ether作为抵押品。

如果验证者愿意提供更多的令牌作为抵押品，他们就有更大的机会记账下一个区块并获得奖励。你可以把奖励的区块看作是存款利息，你在银行存的钱越多，你每月的利息就会越高。

因此，这种共识机制被称为股权证明PoS。

一个拥有大量令牌的验证者会在创建新块时根据持有的令牌数量获得更高的概率。然而，这与我们在工作量证明中看到的并没有什么不同：比特币矿场变得越来越强大，普通人在自己的电脑上开采多年也未必能获得一个区块。

因此，许多人认为，使用了PoS后，区块的分配将更加民主化，因为任何人都可以在自己的笔记本上参与，而不需要建立一个巨大的采矿平台，他们不需要昂贵的硬件，只需要一定的筹码，就算筹码不多，也有一定概率能获得区块的记账权，希望总是有的。

在实际应用中，PoS和PoW都有自己的优点和缺点，因此以太坊的Casper具有两者混合的特征。
### DPoS - EOS
 Delegated Proof of Stake，委任权益证明。

中文名叫做股份授权证明机制（又称受托人机制），它的原理是让每一个持有比特股(比特股使用了dpos)的人进行投票，由此产生101位代表 , 我们可以将其理解为101个超级节点或者矿池，而这101个超级节点彼此的权利是完全相等的。从某种角度来看，DPOS有点像是议会制度或人民代表大会制度。如果代表不能履行他们的职责（当轮到他们时，没能生成区块），他们会被除名，网络会选出新的超级节点来取代他们。

比特股引入了见证人这个概念，见证人可以生成区块，每一个持有比特股的人都可以投票选举见证人。得到总同意票数中的前N个（N通常定义为101）候选者可以当选为见证人，当选见证人的个数（N）需满足：至少一半的参与投票者相信N已经充分地去中心化。

见证人的候选名单每个维护周期（1天）更新一次。见证人然后随机排列，每个见证人按序有2秒的权限时间生成区块，若见证人在给定的时间片不能生成区块，区块生成权限交给下一个时间片对应的见证人。DPoS的这种设计使得区块的生成更为快速，也更加节能。

DPoS充分利用了持股人的投票，以公平民主的方式达成共识，他们投票选出的N个见证人，可以视为N个矿池，而这N个矿池彼此的权利是完全相等的。持股人可以随时通过投票更换这些见证人（矿池），只要他们提供的算力不稳定，计算机宕机，或者试图利用手中的权力作恶。
### PBFT
PBFT是一种状态机副本复制算法，即服务作为状态机进行建模，状态机在分布式系统的不同节点进行副本复制。每个状态机的副本都保存了服务的状态，同时也实现了服务的操作。将所有的副本组成的集合使用大写字母R表示，使用0到|R|-1的整数表示每一个副本。为了描述方便，假设|R|=3f+1，这里f是有可能失效的副本的最大个数。尽管可以存在多于3f+1个副本，但是额外的副本除了降低性能之外不能提高可靠性。

### DPOS机制会比POW机制表现更好吗？
DPOS机制会比POW机制表现更好吗？

共识算法一直都是区块链技术中一个核心所在，目前主流的共识算法为POW、POS、DPOS等。BCH和BCE均是采用了POW算法，今天咱们具体来类比一下DPOS和POW算法的优点缺点。

DPOS机制，中文名股份授权证明机制（又称受托人机制），比如EOS、BTS，均是采用DPOS机制。它的原理就是让每一个持币人进行投票，然后由投票推选出多名代表，或者称超级节点，比如EOS就是21个超级节点，这些超级节点就获得了生产区块的权利，获得交易费奖励。如果超级节点不能履行他们的职责（当轮到他们时，没能生成区块），他们会被除名，网络会选出新的超级节点来取代他们。

POW机制，中文名工作量证明机制，比如BCH，BCE，LTC，均是POW机制。简单来说就是就是一份证明，用来确认你做过一定量的工作。现在一般指的是矿工利用矿机挖矿，投入的算力越多，获得的区块奖励也就越多。POW机制是现在应用最为广泛的共识机制。

**简析DPOS**

延续了POS的优势，因为没有矿机，自然无需消耗电力等资源。同时出块时间更快，在交易中可以获得更快的确认速度。股份授权证明机制与董事会投票类似，用户第一次拥有的投票权，相比较POS来说是一次比较大的突破。但由于投票所需要的时间和精力，绝大部分普通用户是没有投票热情的。此外破坏节点的处理存在诸多困难。社区不能及时有效的阻止一些破坏节点的出现，给网络造成安全隐患。

例如热度很高的EOS，目前也是DPOS极具代表性的数字货币了。EOS的理念很吸引人，由持币人票选出21个超级节点来负责生产打包区块，EOS即将在6月份开始投票，很明显的是参与竞选节点的用户都在拼命的屯币，所以EOS的币价一路在飙升，但实际上多数普通用户并没有投票的热情。此外由于DPOS的特性，如果轮到某个超级节点时，他没能生产出区块，他将会从超级节点中除名，网络会选择新的超级节点取代他。这时就给攻击者机会，如果该超级节点没有强大的算力保护自身，他们很容易收到分布式拒绝服务攻击（DDOS），这将会严重影响网络稳定。

POW简单来说一种没有门槛的算法，任何人都可以投入算力竞争区块奖励。而DPOS延续了POS的弊端，只有持币者才可以获得区块链奖励，其实这就带来了一种制度性门槛，最终导致DPOS币的流动性大大减少，穷者越穷，富者越富。另外，不乏有人将DPOS的劣势作为优势来利用，比如近日，一种使用DPOS机制作为共识算法的IFO币，闪电比特币（简称：LBTC），竟然能人为暂停主链10天，这对去中心化不可篡改的区块链系统来说简直是个笑话。从这一点来看POW算法的去中心化程度是优于DPOS的。
## 没有恶意节点的共识问题
Paxos 问题是指分布式的系统中存在故障（fault），但不存在恶意（corrupt）节点场景（即可能消息丢失或重复，但无错误消息）下的共识达成（Consensus）问题。因为最早是 Leslie Lamport 用 Paxon 岛的故事模型来进行描述而命名。
### Paxos
1990 年由 Leslie Lamport 提出的 Paxos 共识算法，在工程角度实现了一种最大化保障分布式系统一致性（存在极小的概率无法实现一致）的机制。Paxos 被广泛应用在 Chubby、ZooKeeper 这样的系统中，Leslie Lamport 因此获得了 2013 年度图灵奖。

故事背景是古希腊 Paxon 岛上的多个法官在一个大厅内对一个议案进行表决，如何达成统一的结果。他们之间通过服务人员来传递纸条，但法官可能离开或进入大厅，服务人员可能偷懒去睡觉。

Paxos 是第一个被证明的共识算法，其原理基于 两阶段提交 并进行扩展。

作为现在共识算法设计的鼻祖，以最初论文的难懂（算法本身并不复杂）出名。算法中将节点分为三种类型：

proposer：提出一个提案，等待大家批准为结案。往往是客户端担任该角色；
acceptor：负责对提案进行投票。往往是服务端担任该角色；
learner：被告知结案结果，并与之统一，不参与投票过程。可能为客户端或服务端。
并且，算法需要满足 safety 和 liveness 两方面的约束要求（实际上这两个基础属性是大部分分布式算法都该考虑的）：

safety：保证决议结果是对的，无歧义的，不会出现错误情况。
决议（value）只有在被 proposers 提出的 proposal 才能被最终批准；
在一次执行实例中，只批准（chosen）一个最终决议，意味着多数接受（accept）的结果能成为决议；
liveness：保证决议过程能在有限时间内完成。
决议总会产生，并且 learners 能获得被批准（chosen）的决议。
基本过程包括 proposer 提出提案，先争取大多数 acceptor 的支持，超过一半支持时，则发送结案结果给所有人进行确认。一个潜在的问题是 proposer 在此过程中出现故障，可以通过超时机制来解决。极为凑巧的情况下，每次新的一轮提案的 proposer 都恰好故障，系统则永远无法达成一致（概率很小）。

Paxos 能保证在超过1/2的正常节点存在时，系统能达成共识。

读者可以试着自己设计一套能达成共识的方案，会发现在满足各种约束情况下，算法自然就会那样设计。
### Raft
Raft 算法是Paxos 算法的一种简化实现。

包括三种角色：leader、candidate 和 follower，其基本过程为：

Leader 选举：每个 candidate 随机经过一定时间都会提出选举方案，最近阶段中得票最多者被选为 leader；
同步 log：leader 会找到系统中 log 最新的记录，并强制所有的 follower 来刷新到这个记录；