# 双重支付问题

## 比特币双重支付是什么
如果同一笔钱（数字货币）被重复支付两次，就是双重支付问题，解决这个问题就相当于数字货币的防伪技术。这个问题在物理货币世界并不存在，因为你无法复制黄金。在纸币中，由于纸币由造币厂发行的，设计有复杂的防伪技术，如果有人制造了假币，可以通过法律来制止这些行为。但在数字货币中，比特币会对前一次的交易和下一位拥有者的公钥签署一个数字签名，将这个签名附加在比特币的末尾发送给下一位所有者。而由于没有第三方机构去做监控，所以需要一个机制去确保比特币之前的所有者没有对更早发生的交易实施签名。

**比特币是怎样解决这个问题：**

1. 所有的交易全网公开：历史交易全网公开，那么每个账号里面有多少比特币，并不是由一个数据来表示的，而是根据历史交易得出来的。而这个历史交易链是经过全网公认的，才能保证不被造假。

2. 需要有时间戳，所有交易有先后顺序：所有交易，要按照先后顺序，给其加上时间戳，前面一笔交易成功后，整个交易链被公认后，下一笔交易是基于上一笔交易来生成的，整个交易就是一个交易链，这样才能保证不被双重支付。

3. 需要投入计算资源对交易进行确认：交易的确认，需要投入计算资源来确认，比特币引入了工作量证明，矿工投入计算力来打包交易，若需修改某个区块上的交易，需重新计算自区块以来所有区块，参考比特币网络目前的算力，这在数学上几乎是不可能的。

整个比特币系统中的每一个节点都获知每一笔交易的发生，且它们是有时间顺序的，有一个公认的交易序列。那么，只有当大部分节点都认同这笔交易是首次出现时，这笔交易才能发生。唯一可能造成这个系统崩溃的是，有一个人拥有超过整个系统51%的计算能力，那么他就能随意更改每笔交易记录，这就是所谓的“51%攻击”，但这几乎是无法实现的。
## 51%攻击
51%攻击又被称为Majority attack，这种攻击是通过控制网络算力实现双花/双重支付，即一笔token花了两次。双花不会产生新的代币，但能把自己花出去的钱重新拿回来。

攻击者如果拥有超过全网50%的算力，就可以创造一条长度长于原始链的链，俗话说“最长链获胜”。在他控制算力的这段时间，他可以将区块逆转，进行反向交易，实现双花。

比如，攻击者在主链A链中进行一笔交易，交易被确认后，攻击者立即卖掉token，拿到现金。随后，由于控制了51%以上的算力，攻击者在分支B上进行挖矿，让B链的长度超过A链而成为主链，A链上的交易就会被回滚，从而实现双花。也就是说，攻击者之前换成现金的那些token又回到了自己手里。

## 区块链技术如何解决这个问题？
### 时间戳
区块链上的每一块区块都会盖上时间戳，该时间戳证明特定数据与某个特定时间是必然存在的，而每一个时刻都对应了一串唯一随机散列值，后一个时间戳会将前一个时间戳纳入其随机散列值中，并且对前一个时间戳进行增强，以此形成一个链条。
### 分布式
区块链是分布式共享数据库，所有的交易数据都是公开的，并不是由一个数据说了算的，而这个数据只有被全网认可才能被确认为最终交易。
### 共识机制
交易如何被确认。交易的记账权是需要竞争才能获得的，即通过挖矿来计算一个复杂的数学问题，通过提高数学题的难度，可增加所需计算量，这种计算量构建了一个工作量证明机制。如果想要修改某个区块的交易信息，就必须完成该区块和其之后连接区块的所有工作量，这大大增大了篡改数据的难度。除非拥有系统51%以上的算力，而目前是不可能的。全网认可最长的链，因为最长的链包含了最大的工作量，这笔交易就被最终验证。

